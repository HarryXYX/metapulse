plugins {
  id 'org.springframework.boot'
  id 'java'
}

apply from: '../../gradle/coverage/java-coverage.gradle'
apply from: "../../gradle/versioning/versioning.gradle"
apply from: "../../gradle/docker/docker.gradle"

ext {
  docker_repo = 'datahub-gms'
}

ext.apiProject = project(':metadata-service:restli-api')

dependencies {
  implementation project(':metadata-service:factories')
  implementation project(':metadata-service:auth-filter')
  implementation project(':metadata-service:servlet')
  implementation project(':metadata-service:auth-servlet-impl')
  implementation project(':metadata-service:graphql-servlet-impl')
  implementation project(':metadata-service:openapi-servlet')
  implementation project(':metadata-service:openapi-entity-servlet')
  implementation project(':metadata-service:openapi-analytics-servlet')
  implementation project(':metadata-service:schema-registry-servlet')
  runtimeOnly project(':metadata-jobs:mce-consumer')
  runtimeOnly project(':metadata-jobs:mae-consumer')
  runtimeOnly project(':metadata-jobs:pe-consumer')

  runtimeOnly externalDependency.h2
  runtimeOnly externalDependency.mariadbConnector
  runtimeOnly externalDependency.mysqlConnector
  runtimeOnly externalDependency.gcpCloudSqlConnector
  runtimeOnly externalDependency.postgresql

  implementation(externalDependency.springBootStarterWeb)
  implementation(externalDependency.springBootStarterJetty)
  implementation(externalDependency.springBootStarterValidation)

  implementation externalDependency.jettyJmx
  implementation externalDependency.springWebMVC
  implementation externalDependency.springBootAutoconfigure
  implementation externalDependency.servletApi
  runtimeOnly externalDependency.opentelemetryExporter
  runtimeOnly externalDependency.openTelemetryExporterLogging
  runtimeOnly externalDependency.openTelemetryExporterCommon

  implementation spec.product.pegasus.restliDocgen
  implementation spec.product.pegasus.restliSpringBridge

  compileOnly externalDependency.lombok
  annotationProcessor externalDependency.lombok
  runtimeOnly externalDependency.log4jCore
  runtimeOnly externalDependency.log4j2Api
  implementation externalDependency.logbackClassic
  implementation externalDependency.azureIdentityExtensions
  implementation externalDependency.azureIdentity
  testRuntimeOnly externalDependency.logbackClassic
  implementation externalDependency.charle

  // Required for springdocs/swagger
  implementation("javax.xml.bind:jaxb-api:2.3.1")
  implementation("org.glassfish.jaxb:jaxb-runtime:2.3.8")

  testImplementation externalDependency.testng
  testImplementation externalDependency.springBootTest
  testRuntimeOnly externalDependency.logbackClassic
}
configurations.all{
  exclude group: "com.charleskorn.kaml", module:"kaml"
}

tasks.register('run') {
  group = 'application'  // Add a group for better organization
  description = 'Runs the application with Gretty'
  dependsOn 'bootRun' // spring task
}

bootJar {
  // backwards compatible with old war archive name
  archiveFileName = 'war.war'
  mainClass = 'com.linkedin.gms.GMSApplication'
}

bootRun {
  environment "SCHEMA_REGISTRY_TYPE", "INTERNAL"
  environment "KAFKA_SCHEMAREGISTRY_URL", "http://localhost:8080/schema-registry/api"
}

docker {
  dependsOn bootJar
  name "${docker_registry}/${docker_repo}:${versionTag}"
  dockerfile file("${rootProject.projectDir}/docker/${docker_repo}/Dockerfile")
  files bootJar.outputs.files
  files fileTree(rootProject.projectDir) {
    include '.dockerignore'
    include 'docker/monitoring/*'
    include "docker/${docker_repo}/*"
    include 'metadata-models/src/main/resources/*'
  }.exclude {
    i -> (!i.file.name.endsWith(".dockerignore") && i.file.isHidden())
  }
  additionalTag("Debug", "${docker_registry}/${docker_repo}:debug")

  // Add build args if they are defined (needed for some CI or enterprise environments)
  def dockerBuildArgs = [:]
  if (project.hasProperty('alpineApkRepositoryUrl')) {
    dockerBuildArgs.ALPINE_REPO_URL = project.getProperty('alpineApkRepositoryUrl')
  }
  if (project.hasProperty('githubMirrorUrl')) {
    dockerBuildArgs.GITHUB_REPO_URL = project.getProperty('githubMirrorUrl')
  }
  if (project.hasProperty('mavenCentralRepositoryUrl')) {
    dockerBuildArgs.MAVEN_CENTRAL_REPO_URL = project.getProperty('mavenCentralRepositoryUrl')
  }

  if (dockerBuildArgs.size() > 0) {
    buildArgs(dockerBuildArgs)
  }

  debugBuildArgs = [APP_ENV:  'dev']
}

test {
  jacoco {
    // This contains quickstart tested code for jetty startup
    excludes = ["com.linkedin.gms.CommonApplicationConfig",
                "com.linkedin.gms.ServletConfig",
                "com.linkedin.gms.GMSApplication"]
  }
}

// ===== å‰åç«¯é›†æˆé…ç½® =====
// å®šä¹‰å‰ç«¯æ„å»ºäº§ç‰©è·¯å¾„
def frontendDistDir = file("${rootProject.projectDir}/../frontend/dist")
def staticResourcesDir = file("${projectDir}/src/main/resources/static")

// æ¸…ç†é™æ€èµ„æºç›®å½•
tasks.register('cleanStaticResources', Delete) {
  group = 'build'
  description = 'æ¸…ç†åç«¯é™æ€èµ„æºç›®å½•'
  delete staticResourcesDir
}

// å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©åˆ°é™æ€èµ„æºç›®å½•
tasks.register('copyFrontendDist', Copy) {
  group = 'build'
  description = 'å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©åˆ°åç«¯é™æ€èµ„æºç›®å½•'
  dependsOn cleanStaticResources

  from frontendDistDir
  into staticResourcesDir

  // åªåœ¨å‰ç«¯æ„å»ºäº§ç‰©å­˜åœ¨æ—¶æ‰§è¡Œ
  onlyIf {
    frontendDistDir.exists() && frontendDistDir.listFiles().length > 0
  }

  doLast {
    if (frontendDistDir.exists() && frontendDistDir.listFiles().length > 0) {
      logger.lifecycle("âœ… å‰ç«¯èµ„æºå·²å¤åˆ¶åˆ°: ${staticResourcesDir}")
    } else {
      logger.warn("âš ï¸  å‰ç«¯æ„å»ºäº§ç‰©ä¸å­˜åœ¨: ${frontendDistDir}")
      logger.warn("   è¯·å…ˆè¿è¡Œ: cd ../frontend && yarn build")
    }
  }
}

// æ„å»ºå‰ç«¯ï¼ˆå¯é€‰ï¼Œä¸»è¦åœ¨ CI ç¯å¢ƒä½¿ç”¨ï¼‰
tasks.register('buildFrontend', Exec) {
  group = 'build'
  description = 'æ„å»ºå‰ç«¯åº”ç”¨ï¼ˆéœ€è¦ Node.js å’Œ Yarnï¼‰'
  workingDir "${rootProject.projectDir}/../frontend"

  // æ ¹æ®æ“ä½œç³»ç»Ÿé€‰æ‹©å‘½ä»¤
  if (System.getProperty('os.name').toLowerCase().contains('windows')) {
    commandLine 'cmd', '/c', 'yarn', 'build'
  } else {
    commandLine 'sh', '-c', 'yarn build'
  }

  // åªåœ¨ CI ç¯å¢ƒæˆ–æ˜ç¡®æŒ‡å®šæ—¶æ‰§è¡Œ
  onlyIf {
    System.getenv('CI') == 'true' ||
    project.hasProperty('buildFrontend') ||
    project.hasProperty('fullBuild')
  }

  doFirst {
    logger.lifecycle("ğŸ—ï¸  å¼€å§‹æ„å»ºå‰ç«¯åº”ç”¨...")
  }

  doLast {
    logger.lifecycle("âœ… å‰ç«¯æ„å»ºå®Œæˆ")
  }
}

// å®Œæ•´çš„å‰ç«¯æ„å»ºå’Œé›†æˆæµç¨‹
tasks.register('integrateFrontend') {
  group = 'build'
  description = 'å®Œæ•´çš„å‰ç«¯æ„å»ºå’Œé›†æˆæµç¨‹ï¼ˆæ„å»º + å¤åˆ¶ï¼‰'
  dependsOn buildFrontend
  dependsOn copyFrontendDist

  // ç¡®ä¿æ„å»ºåœ¨å¤åˆ¶ä¹‹å‰å®Œæˆ
  buildFrontend.finalizedBy copyFrontendDist
}

// ä¿®æ”¹ processResources ä»»åŠ¡ï¼Œåœ¨å¤„ç†èµ„æºå‰å¤åˆ¶å‰ç«¯èµ„æº
// è¿™æ ·å¯ä»¥ç¡®ä¿å‰ç«¯èµ„æºè¢«åŒ…å«åœ¨æœ€ç»ˆçš„ WAR åŒ…ä¸­
processResources {
  dependsOn copyFrontendDist
}

// æ·»åŠ ä¸€ä¸ªå¿«æ·ä»»åŠ¡ï¼šåªæ„å»ºå¹¶å¤åˆ¶å‰ç«¯èµ„æºï¼Œä¸æ„å»ºæ•´ä¸ªåç«¯
tasks.register('frontendOnly') {
  group = 'build'
  description = 'ä»…æ„å»ºå‰ç«¯å¹¶å¤åˆ¶åˆ°é™æ€èµ„æºç›®å½•ï¼ˆä¸æ„å»ºåç«¯ï¼‰'
  dependsOn integrateFrontend
}
