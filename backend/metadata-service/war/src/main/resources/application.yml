# MetaPulse All-in-One Configuration
# 完全单体架构 - Web服务 + Kafka Consumers

server:
  port: ${SERVER_PORT:8080}
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
  tomcat:
    max-connections: ${MAX_CONNECTIONS:8000}
    max-threads: ${MAX_THREADS:200}

# ===== 关键配置：启用所有Consumer（All-in-One模式） =====
# 这些环境变量控制Consumer是否启动
environment:
  MAE_CONSUMER_ENABLED: "${MAE_CONSUMER_ENABLED:true}"
  MCE_CONSUMER_ENABLED: "${MCE_CONSUMER_ENABLED:true}"
  MCP_CONSUMER_ENABLED: "${MCP_CONSUMER_ENABLED:true}"
  PE_CONSUMER_ENABLED: "${PE_CONSUMER_ENABLED:true}"

# ===== Entity Client配置（使用本地Java模式，无HTTP调用） =====
entityClient:
  impl: ${ENTITY_CLIENT_IMPL:java}  # java=本地方法调用, restli=HTTP调用

# ===== Spring配置 =====
spring:
  application:
    name: metapulse-all-in-one

  # 数据库配置
  datasource:
    url: jdbc:${DB_TYPE:mysql}://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_DATABASE:metapulse}?useUnicode=true&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true
    username: ${DB_USERNAME:metapulse}
    password: ${DB_PASSWORD:metapulse}
    driver-class-name: ${DB_DRIVER:com.mysql.cj.jdbc.Driver}

    # HikariCP连接池配置（Web + Consumer共享）
    hikari:
      maximum-pool-size: ${DB_POOL_MAX:50}
      minimum-idle: ${DB_POOL_MIN:10}
      connection-timeout: ${DB_CONN_TIMEOUT:30000}
      idle-timeout: 600000
      max-lifetime: 1800000
      leak-detection-threshold: 60000

  jpa:
    hibernate:
      ddl-auto: none
    show-sql: false
    properties:
      hibernate:
        dialect: ${HIBERNATE_DIALECT:org.hibernate.dialect.MySQL8Dialect}

  # 静态资源配置（前端资源服务）
  web:
    resources:
      static-locations: classpath:/static/
      cache:
        period: ${STATIC_CACHE_PERIOD:31536000}  # 默认1年缓存（生产环境）
        cachecontrol:
          max-age: ${STATIC_CACHE_MAX_AGE:31536000}
          must-revalidate: false
      chain:
        enabled: ${STATIC_CHAIN_ENABLED:true}
        compressed: ${STATIC_COMPRESSED:true}

  # MVC 配置
  mvc:
    static-path-pattern: /**  # 静态资源路径模式
    servlet:
      path: /  # Servlet 路径

# ===== Kafka配置 =====
kafka:
  bootstrapServers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}

  schemaRegistry:
    url: ${KAFKA_SCHEMA_REGISTRY_URL:http://localhost:8080/schema-registry/api}
    type: ${KAFKA_SCHEMA_REGISTRY_TYPE:INTERNAL}

  # Producer配置（Web服务使用）
  producer:
    acks: ${KAFKA_PRODUCER_ACKS:all}
    retries: ${KAFKA_PRODUCER_RETRIES:3}
    compressionType: ${KAFKA_PRODUCER_COMPRESSION:snappy}
    maxRequestSize: 1048576

  # Consumer配置（Consumer模块使用）
  consumer:
    groupId: ${KAFKA_CONSUMER_GROUP_ID:metapulse-consumers}
    autoOffsetReset: ${KAFKA_AUTO_OFFSET_RESET:earliest}
    maxPollRecords: ${KAFKA_MAX_POLL_RECORDS:100}
    enableAutoCommit: false
    sessionTimeoutMs: 30000
    maxPollIntervalMs: 300000

  # Kafka Consumer并发配置
  listener:
    concurrency: ${KAFKA_LISTENER_CONCURRENCY:4}  # 每个Consumer的并发线程数

# ===== Elasticsearch配置 =====
elasticsearch:
  host: ${ELASTICSEARCH_HOST:localhost}
  port: ${ELASTICSEARCH_PORT:9200}
  scheme: ${ELASTICSEARCH_SCHEME:http}
  username: ${ELASTICSEARCH_USERNAME:}
  password: ${ELASTICSEARCH_PASSWORD:}
  threadCount: ${ELASTICSEARCH_THREAD_COUNT:4}
  connectionRequestTimeout: ${ELASTICSEARCH_CONN_TIMEOUT:30000}
  bulkProcessor:
    requestsLimit: ${ES_BULK_REQUESTS_LIMIT:1000}
    flushPeriod: ${ES_BULK_FLUSH_PERIOD:1}
    numRetries: ${ES_BULK_RETRIES:3}
    retryInterval: ${ES_BULK_RETRY_INTERVAL:1}

# ===== DataHub GMS配置 =====
datahub:
  gms:
    host: ${DATAHUB_GMS_HOST:0.0.0.0}
    port: ${DATAHUB_GMS_PORT:8080}
    useSSL: ${DATAHUB_GMS_USE_SSL:false}
    sslContext:
      protocol: ${DATAHUB_GMS_SSL_PROTOCOL:TLSv1.2}
    async:
      request-timeout-ms: ${ASYNC_REQUEST_TIMEOUT:30000}

# ===== 缓存配置 =====
cache:
  client:
    entityClient:
      useCaffeineCache: ${USE_CAFFEINE_CACHE:true}
      statsEnabled: ${CACHE_STATS_ENABLED:true}

# ===== 认证配置 =====
authentication:
  enabled: ${AUTH_ENABLED:true}
  systemClientId: ${SYSTEM_CLIENT_ID:__datahub_system}
  systemClientSecret: ${SYSTEM_CLIENT_SECRET:JohnSnowKnowsNothing}
  tokenService:
    signingKey: ${TOKEN_SERVICE_SIGNING_KEY:WnVBrnu2tBFoY5rLnQmVlQ==}

# ===== 日志配置 =====
logging:
  level:
    root: ${LOG_LEVEL:INFO}
    com.linkedin: ${DATAHUB_LOG_LEVEL:INFO}
    org.springframework: ${SPRING_LOG_LEVEL:WARN}
    org.apache.kafka: ${KAFKA_LOG_LEVEL:WARN}
    io.datahubproject: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"

# ===== 管理和监控端点 =====
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: ${HEALTH_SHOW_DETAILS:when-authorized}
  metrics:
    export:
      prometheus:
        enabled: ${PROMETHEUS_ENABLED:true}

# ===== 其他配置 =====
metadataChangeProposal:
  throttle:
    updateIntervalMs: ${MCP_THROTTLE_UPDATE_INTERVAL:60000}

visualConfig:
  assets:
    logoUrl: ${REACT_APP_LOGO_URL:/assets/platforms/metapulselogo.png}

telemetry:
  enabledCli: ${DATAHUB_TELEMETRY_ENABLED:true}
  enabledServer: ${DATAHUB_TELEMETRY_ENABLED:true}

# ===== Ebean ORM 配置 =====
ebean:
  username: ${EBEAN_DATASOURCE_USERNAME:${DB_USERNAME:metapulse}}
  password: ${EBEAN_DATASOURCE_PASSWORD:${DB_PASSWORD:metapulse}}
  url: jdbc:${DB_TYPE:mysql}://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_DATABASE:metapulse}?useUnicode=true&characterEncoding=UTF-8&useSSL=false&allowPublicKeyRetrieval=true
  driver: ${EBEAN_DATASOURCE_DRIVER:${DB_DRIVER:com.mysql.cj.jdbc.Driver}}
  minConnections: ${EBEAN_MIN_CONNECTIONS:2}
  maxConnections: ${EBEAN_MAX_CONNECTIONS:50}
  maxInactiveTimeSeconds: ${EBEAN_MAX_INACTIVE_TIME_SECONDS:120}
  maxAgeMinutes: ${EBEAN_MAX_AGE_MINUTES:120}
  leakTimeMinutes: ${EBEAN_LEAK_TIME_MINUTES:15}
  waitTimeoutMillis: ${EBEAN_WAIT_TIMEOUT_MILLIS:1000}
  autoCreateDdl: ${EBEAN_AUTOCREATE:false}

# ===== Entity Registry 配置 =====
# 使用 classpath resource 方式加载（从 metadata-models.jar 中加载）
configEntityRegistry:
  path: ${ENTITY_REGISTRY_CONFIG_PATH:#{null}}  # 明确设置为 null，避免使用相对路径
  resource: classpath:entity-registry.yml

# ===== 系统更新配置 =====
# 跳过系统更新等待，加快启动速度（All-in-One模式）
systemUpdate:
  waitForSystemUpdate: ${BOOTSTRAP_SYSTEM_UPDATE_WAIT_FOR_SYSTEM_UPDATE:false}
